#author's note: this can be directly copied into R and directly merged with other code on this github :)

#---------------------------------------DESeq2---------------------------------------
#load your count data file
count_data <- read.csv("/Volumes/Emi's Drive/Emily Easter/Emily RNA/reusable files/count_matrix.csv", 
                       row.names = 1)
head(count_data)

#metadata table, define your levels, replicates and conditions 
sample_info <- data.frame(
  sample = colnames(count_data),
  condition = factor(c(rep("treated", 4), rep("untreated", 4)),
                     levels = c("untreated", "treated"))  
)

#create DESeqDataSet
dds <- DESeqDataSetFromMatrix(countData = count_data, 
                              colData = sample_info, 
                              design = ~ condition)
dds

#pre-filter (min nr = 10)
smallestGroupSize <- 3
keep <- rowSums(counts(dds) >= 10) >= smallestGroupSize
dds <- dds[keep,]

#run DESeq2
dds <- DESeq(dds)

#get and save results (note: this is not filtered for significance just yet)
DESeqresults <- results(dds, contrast = c("condition", "treated", "untreated"))
write.csv(DESeqresults, 
          file = "/Volumes/Emi's Drive/Emily Easter/Emily RNA/reusable files/DESeqresults.csv", 
          row.names = TRUE)

#filter for significance + save to your files 
sum(DESeqresults$padj < 0.01, na.rm = TRUE)
sig_genes <- DESeqresults[which(DESeqresults$padj < 0.01 & !is.na(DESeqresults$padj)), ]
write.csv(as.data.frame(sig_genes), 
          file = "/Volumes/Emi's Drive/Emily Easter/Emily RNA/reusable files/significant_genes_p01.csv", 
          row.names = TRUE)

#optional: save a files with only gene IDs that you can run through FlyBase or other tools
write.table(rownames(sig_genes), 
            file = "/Volumes/Emi's Drive/Emily Easter/Emily RNA/reusable files/sig_gene_ids_p01.txt", 
            row.names = FALSE, col.names = FALSE, quote = FALSE)


#---------------------------------------plots+more---------------------------------------
#shrink log2 fold changes (recommended)
DESeqresultsLFC <- lfcShrink(dds, coef = "condition_treated_vs_untreated", type = "apeglm")

#make MA plots (shrunken and regular) that can be saved to your files directly from the plot viewer
#PDF on A4 size recommended for good quality

#MA plot 1
plotMA(DESeqresults, ylim=c(-2,2))
#MA plot 2 (shrunken)
plotMA(DESeqresultsLFC, ylim = c(-2, 2))

#make a fun heatmap!
vsd <- vst(dds, blind = FALSE)
sig_genes <- rownames(DESeqresults[which(DESeqresults$padj < 0.01 & !is.na(DESeqresults$padj)), ])
sig_expr <- assay(vsd)[sig_genes, ]
#set legend
colnames(sig_expr) <- c("T1", "T2", "T3", "T4", "U1", "U2", "U3", "U4")
annotation_col <- as.data.frame(colData(dds)["condition"])
rownames(annotation_col) <- colnames(sig_expr)

#heatmap 1
pheatmap(sig_expr,
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         scale = "row",
         show_rownames = FALSE,
         annotation_col = annotation_col)











